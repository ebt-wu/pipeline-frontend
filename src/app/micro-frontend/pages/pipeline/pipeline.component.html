<div class="variable-overwrites">
  <fd-flexible-column-layout [(layout)]="localLayout">
    <ng-template #startColumn>
      <div *ngIf="pipeline$ | async as pipeline; else skeleton">
        <div class="ci-cd-header">
          <fd-card cardType="linkList">
            <fd-card-content class="header">
              <div class="header-content">
                <h1 class="header-text"><strong>CI/CD Setup</strong></h1>
                <div class="header-debug-mode" *ngIf="debugModeService.debugModeEnabled()">
                  <span>Debug Mode</span>
                  <i class="header-debug-text">disable with CTRL + D</i>
                </div>
                <div class="header-buttons">
                  <button
                    class="header-button"
                    fd-button
                    label="Give Feedback"
                    fdType="emphasized"
                    (click)="openFeedback()"
                    *ngIf="isBuildPipelineSetup() && localLayout === 'OneColumnStartFullScreen'"></button>
                  <fd-busy-indicator [loading]="pendingShowCredentials()" size="s">
                    <button
                      fd-button
                      label="Show Credentials"
                      [disabled]="pendingShowCredentials()"
                      fdType="transparent"
                      glyph="key"
                      ariaLabel="Show Credentials"
                      (click)="showCredentials()"></button>
                  </fd-busy-indicator>
                  <button
                    title="Show documentation"
                    role="button"
                    class="header-button"
                    fdType="transparent"
                    glyph="sys-help"
                    *ngIf="localLayout === 'OneColumnStartFullScreen'"
                    fd-button
                    (click)="openDocumentation()"></button>
                </div>
              </div>
            </fd-card-content>
          </fd-card>
        </div>
        <div class="pipeline-container">
          <div class="pipeline-header">
            <h3 class="heading">Your Pipeline</h3>
            <button
              *ngIf="debugModeService.debugModeEnabled()"
              fd-button
              fdType="transparent"
              glyph="detail-view"
              ariaLabel="Pipeline Details"
              (click)="openPipelineDebugModal($event)"></button>
            <code *ngIf="debugModeService.debugModeEnabled()">Name: {{ pipeline.name }}</code>
          </div>
          <div *ngFor="let error of errors()">
            <error-message [title]="error.title" [message]="error.message"></error-message>
          </div>
          <dismissible-message
            *ngIf="isBuildPipelineSetup()"
            type="success"
            message="YAY! Your build pipeline is set up."
            [showOnlyOnce]="true"
            [displayLink]="true"
            linkText="See It in Action"
            [href]="pipelineURL()"></dismissible-message>
          <fd-message-strip class="pull-requests-message" type="warning" *ngIf="this.openPRCount()">
            Merge {{ this.openPRCount() }} open pull requests.
            <a
              fd-link
              [href]="this.githubMetadata.githubRepoUrl + '/pulls'"
              target="_blank"
              *ngIf="this.githubMetadata.githubRepoUrl">
              Open Github
            </a>
          </fd-message-strip>
          <fd-card cardType="linkList" class="stage-card">
            <fd-card-content class="card-content-padding">
              <div class="card-content build-stage-padding" (click)="openBuildStage()">
                <div class="icons">
                  <fd-avatar *ngIf="!isBuildStageSetup()" [colorAccent]="1" size="m" glyph="wrench"></fd-avatar>
                  <fd-icon
                    *ngIf="!isBuildStageOpen() && isBuildStageSetup()"
                    glyph="slim-arrow-right"
                    class="icon"></fd-icon>
                  <fd-icon *ngIf="isBuildStageOpen()" glyph="slim-arrow-down" class="icon"></fd-icon>
                </div>
                <div class="card-description">
                  <div class="card-description-build">
                    <h1 [ngClass]="isBuildStageSetup() ? 'stage-setup-header' : ''"><strong>Build</strong></h1>
                    <fd-info-label
                      *ngIf="isBuildStageSetup()"
                      label="Compliant Setup"
                      color="8"
                      title="New"></fd-info-label>
                  </div>
                  <p *ngIf="!isBuildStageSetup()">Get a pipeline that builds and packages your code</p>
                </div>
                <div class="spacer"></div>
                <button
                  *ngIf="!isBuildStageSetup()"
                  fd-button
                  label="Set Up"
                  fdType="emphasized"
                  (click)="openSetupWizard($event)"></button>
                <button
                  *ngIf="isBuildStageSetup() && !pendingDeletion()"
                  fd-button
                  title="Delete"
                  glyph="delete"
                  (click)="deletePipeline($event, pipeline)"></button>
                <fd-busy-indicator [loading]="pendingOpenPipeline()" size="s">
                  <a
                    [href]="pipelineURL()"
                    *ngIf="showOpenPipelineURL"
                    fd-link
                    (click)="$event.stopPropagation()"
                    target="_blank"
                    [style.pointer-events]="showOpenPipelineURL && pipelineURL() ? '' : 'none'">
                    Open Pipeline
                  </a>
                </fd-busy-indicator>
                <fd-busy-indicator
                  *ngIf="isBuildStageSetup() && pendingDeletion()"
                  [loading]="true"
                  ariaLabel="loading"
                  label="Pending Deletion"></fd-busy-indicator>
              </div>
              <ng-container *ngIf="isBuildStageOpen()">
                <div *ngFor="let resourceRef of pipeline.resourceRefs">
                  <!-- CumulusGroup should be ignored for the UI, since CumulusPipeline is the valid reference for a single pipeline -->
                  <div *ngIf="resourceRef.kind !== 'CumulusGroup'">
                    <!--The GithubAction resource is not part of the build stage yet. -->
                    <div class="card" *ngIf="resourceRef.kind !== 'GithubAction'">
                      <app-service-list-item
                        [resourceRef]="resourceRef"
                        [activeTile]="activeTile"
                        [localLayout]="localLayout"
                        (openDetailsEvent)="openDetails($event)"></app-service-list-item>
                    </div>
                  </div>
                </div>
              </ng-container>
            </fd-card-content>
          </fd-card>
          <fd-card cardType="linkList" class="stage-card disabled">
            <fd-card-content>
              <div class="coming-soon-stage">
                <div class="card-content">
                  <fd-avatar [colorAccent]="10" size="m" glyph="shield"></fd-avatar>
                  <div class="card-description">
                    <h1 class="disabled-headline"><strong>Validate</strong></h1>
                    <p>Get feedback on the compliance of your code</p>
                  </div>
                </div>
                <fd-info-label label="Coming Soon" color="10" title="Coming Soon"></fd-info-label>
              </div>
            </fd-card-content>
          </fd-card>
          <fd-card cardType="linkList" class="stage-card disabled">
            <fd-card-content>
              <div class="coming-soon-stage">
                <div class="card-content">
                  <fd-avatar [colorAccent]="10" size="m" glyph="shipping-status"></fd-avatar>
                  <div class="card-description">
                    <h1 class="disabled-headline"><strong>Deploy</strong></h1>
                    <p>Enable a deployment of your packaged code</p>
                  </div>
                </div>
                <fd-info-label fdCozy label="Coming Soon" color="10" title="Coming Soon"></fd-info-label>
              </div>
            </fd-card-content>
          </fd-card>
          <h3 class="single-services">Single Services</h3>
          <ng-container
            *ngIf="!pendingExtensionClass() && isGithubActionsEnabledAlready$ | async as gha; else loadingContent">
            <!--the below card will be shown if the Github Actions is already enabled from an another component.-->
            <fd-card cardType="list" *ngIf="gha.isAlreadyManaged; else notEnabled">
              <fd-card-content *ngIf="!isGithubActionsEnabledInSameComponent()">
                <div class="github-actions-single-service">
                  <div class="card-content">
                    <span
                      fd-object-status
                      class="status-icon"
                      size="l"
                      status="positive"
                      glyph="message-success"></span>
                    <fd-avatar
                      size="s"
                      image="{{ getIcon(kinds.GITHUB_ACTION) }}"
                      [label]="kindName[kinds.GITHUB_ACTION]"
                      [colorAccent]="10"></fd-avatar>
                    <div class="card-description">
                      <h1 class="card-header"><strong>Github Actions</strong></h1>
                      <fd-info-label fdCozy label="Orchestration" color="10" title="Orchestrator"></fd-info-label>
                    </div>
                    <p *ngIf="!isGithubActionsEnabledInSameProject(gha.responsibleProject)">
                      The Github Actions for the
                      <strong>{{ this.githubMetadata.githubOrgName }}</strong>
                      organization is already enabled in one of the components of the
                      <strong>{{ gha.responsibleProject }}</strong>
                      project.
                    </p>
                    <p *ngIf="isGithubActionsEnabledInSameProject(gha.responsibleProject)">
                      The Github Actions for the
                      <strong>{{ this.githubMetadata.githubOrgName }}</strong>
                      organization is already enabled in one of the other components of the same project
                      <strong>{{ gha.responsibleProject }}</strong>
                      .
                    </p>
                  </div>
                </div>
              </fd-card-content>
            </fd-card>
            <ng-template #notEnabled>
              <fd-card *ngIf="!isGithubActionsEnabledInSameComponent()" cardType="list">
                <fd-card-content>
                  <div class="github-actions-single-service">
                    <div class="card-content">
                      <fd-avatar
                        size="s"
                        image="{{ getIcon(kinds.GITHUB_ACTION) }}"
                        [label]="kindName[kinds.GITHUB_ACTION]"
                        [colorAccent]="10"></fd-avatar>
                      <div class="card-description">
                        <div class="card-content-github-actions">
                          <h1 class="card-header"><strong>Github Actions</strong></h1>
                          <fd-info-label
                            class="card-content-label"
                            fdCozy
                            label="New"
                            color="7"
                            title="New"></fd-info-label>
                        </div>
                        <div class="card-content-github-actions">
                          <fd-info-label fdCozy label="Orchestration" color="10" title="Orchestrator"></fd-info-label>
                        </div>
                      </div>
                    </div>
                    <button
                      class="card-content"
                      fd-button
                      label="Set Up"
                      fdType="emphasized"
                      (click)="openGithubActionWizard($event)"></button>
                  </div>
                </fd-card-content>
              </fd-card>
            </ng-template>
            <!--The GithubAction is enabled in the same component and the status of the Github Actions resource will be shown-->
            <fd-card cardType="list" *ngIf="isGithubActionsEnabledInSameComponent()">
              <fd-card-content class="github-actions-result">
                <div *ngFor="let resourceRef of pipeline.resourceRefs">
                  <div *ngIf="resourceRef.kind === 'GithubAction'">
                    <app-service-list-item
                      [resourceRef]="resourceRef"
                      [activeTile]="activeTile"
                      [localLayout]="localLayout"
                      (openDetailsEvent)="openDetails($event)"></app-service-list-item>
                  </div>
                </div>
              </fd-card-content>
            </fd-card>
          </ng-container>
        </div>
      </div>
      <ng-template #skeleton>
        <fd-skeleton type="rectangle" width="100%" height="6rem"></fd-skeleton>
        <div class="pipeline-container">
          <fd-skeleton type="text" width="15rem" textLines="2" class="skeleton-text"></fd-skeleton>
          <fd-skeleton type="rectangle" width="100%" height="6rem" class="skeleton-top-margin"></fd-skeleton>
          <fd-skeleton type="rectangle" width="100%" height="6rem" class="skeleton-top-margin"></fd-skeleton>
          <fd-skeleton type="rectangle" width="100%" height="6rem" class="skeleton-top-margin"></fd-skeleton>
        </div>
      </ng-template>
    </ng-template>
    <ng-template #midColumn>
      <app-service-details-skeleton
        [activeTile]="activeTile"
        [localLayout]="localLayout"
        (localLayoutEvent)="updateLocalLayout($event)"></app-service-details-skeleton>
    </ng-template>
  </fd-flexible-column-layout>
</div>

<ng-template #loadingContent>
  <fd-busy-indicator [loading]="true" ariaLabel="loading" title="Please Wait"></fd-busy-indicator>
</ng-template>
